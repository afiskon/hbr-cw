#include "spur_masking.h"

// Spurs seem to be inevitable in a 2-IF homebrew receiver. At least I didn't
// manage to get rid of them using filters or shields. They can be masked
// though, by changing CLAR and/or SHIFT just a bit. It is worth noticing that
// I live in a noisy area and my power supply is not particularly clean, so not
// all listed frequencies are necessarily real spurs. Also most of them are
// barely hearable, but I decided to hide them anyway because I could.

// Also, consider tweaking IF2Frequency variable.

// Keep the list sorted by frequency, otherwise getSpurMaskingInfo()
// procedure will not work!
static const SpurMaskInfo SpurMaskInfoArray[] = {
	// 80 meters
	{ 3500200, 0, 10, false },
	{ 3501300, 0, 10, false },
	{ 3501600, 50, 0, false },
	{ 3501700, 50, 0, false },
	{ 3502000, 0, -10, false },
	{ 3503400, 50, 0, false },
	{ 3503700, 0, 10, false },
	{ 3503800, 0, 10, false },
	{ 3504100, 0, 10, false },
	{ 3505500, 0, -10, false },
	{ 3505600, 0, -40, false },
	{ 3505800, 0, -20, false },
	{ 3505900, 50, -20, false },
	{ 3506000, 0, -30, false },
	{ 3506100, 0, -50, false },
	{ 3506200, 0, -40, false },
	{ 3506300, 0, -100, false },
	{ 3506400, 0, 50, false },
	{ 3506500, 0, 50, false },
	{ 3506600, 0, 20, false },
	{ 3506900, -50, 0, false },
	{ 3507900, 0, -10, false },
	{ 3510000, 0, -20, false },
	{ 3512400, 0, -10, false },
	{ 3513500, 50, 0, false },
	{ 3517700, -50, 0, false },
	{ 3520000, 0, 20, false },
	{ 3520200, 0, -10, false },
	{ 3520400, 0, 20, false },
	{ 3520700, 0, -10, false },
	{ 3521700, 0, 40, false },
	{ 3521800, 50, 0, false },
	{ 3522700, 0, -10, false },
	{ 3523000, 0, -20, false },
	{ 3525100, 0, -10, false },
	{ 3526000, 0, -10, false },
	{ 3527300, 50, 0, false },
	{ 3527400, 50, 0, false },
	{ 3527900, 0, 20, false },
	{ 3528100, 0, 30, false },
	{ 3528200, 0, 30, false },
	{ 3528300, 50, 0, false },
	{ 3530000, 0, 30, false },
	{ 3530500, 0, -10, false },
	{ 3530900, 50, 0, false },
	{ 3533100, 0, -40, false },
	{ 3533800, 0, -10, false },
	{ 3534100, 0, 70, false },
	{ 3534700, 0, -30, false },
	{ 3534800, 0, -30, false },
	{ 3535200, 0, 20, false },
	{ 3535500, 0, 40, false },
	{ 3536000, 0, 10, false },
	{ 3536800, 0, 20, false },
	// 3.537.4, 3.537.5: alternative IF2 freq
	{ 3537400, 0, 0, true }, 
	{ 3537500, 0, 0, true },
	{ 3537700, 0, 20, false },
	{ 3538500, 50, 0, false },
	{ 3538700, 0, -10, false },
	{ 3540400, 0, -20, false },
	{ 3540600, 0, -10, false },
	{ 3541400, 50, 0, false },
	{ 3541900, 0, -10, false },
	{ 3543100, 0, -10, false },
	{ 3543900, 0, -10, false },
	{ 3544000, 0, -10, false },
	{ 3544100, 0, -10, false },
	{ 3544200, 0, -10, false },
	{ 3544300, 0, -10, false },
	{ 3544400, 0, -10, false },
	{ 3544800, 0, -20, false },
	{ 3545100, 0, 10, false },
	{ 3545500, 0, 10, false },
	{ 3546700, 0, 10, false },
	{ 3547400, 0, 10, false },
	{ 3548500, 0, 10, false },
	{ 3548700, 0, -30, false },
	{ 3548900, 0, -30, false },
	{ 3550800, 0, 10, false },
	{ 3551300, 0, 10, false },
	{ 3551500, 0, 10, false },
	{ 3552100, 50, 10, false },
	{ 3559200, 0, 20, false },
	{ 3559600, 0, 30, false },
	{ 3559700, 0, 30, false },
	{ 3560600, 0, -10, false },
	{ 3561900, 50, 0, false },
	{ 3562400, 0, -20, false },
	{ 3562500, 0, -20, false },
	{ 3565400, 50, 0, false },
	{ 3565100, 0, -10, false },
	{ 3565700, 0, -10, false },
	{ 3566700, 0, -10, false },
	{ 3567800, 0, -10, false },
	{ 3568200, 0, -10, false },
	{ 3568600, 0, -10, false },
	{ 3568900, 50, 0, false },

	// 40 meters
	{ 7000000, 50, 10, false },
	{ 7000200, 0, 30, false },
	{ 7000600, 0, 10, false },
	{ 7000800, 50, 30, false },
	{ 7001000, 0, -20, false },
	{ 7001100, 50, 0, false },
	{ 7001200, 50, 0, false },
	{ 7001300, 50, 0, false },
	{ 7001300, 0, -30, false },
	{ 7001400, 0, -30, false },
	{ 7001700, 0, 10, false },
	{ 7001900, 0, 10, false },
	{ 7002500, 50, 10, false },
	{ 7002700, 0, -20, false },
	{ 7002900, 0, -10, false },
	{ 7003100, 50, 0, false },
	{ 7003300, -50, 0, false },
	{ 7003400, 0, -30, false },
	{ 7003500, -50, -30, false },
	{ 7003600, 0, -30, false },
	{ 7003800, 0, -10, false },
	{ 7004200, 0, -20, false },
	{ 7004400, 0, -20, false },
	{ 7004800, 0, 20, false },
	{ 7005000, 0, -10, false },
	{ 7005100, 0, -30, false },
	{ 7005100, 0, -50, false },
	// 7.005.3-7.006.5: alternative IF2 freq
	{ 7005300, 0, -10, true },
	{ 7005400, 0, 0, true },
	{ 7005500, 0, 0, true },
	{ 7005600, 0, 10, true },
	{ 7005700, 0, 0, true },
	{ 7005800, 0, 0, true },
	{ 7005900, 0, -10, true },
	{ 7006000, 0, 0, true },
	{ 7006100, 0, 0, true },
	{ 7006200, 0, -10, true },
	{ 7006300, 0, -30, true },
	{ 7006400, 0, 10, true },
	{ 7006500, 0, 0, true },
	{ 7006600, 0, 40, false },
	{ 7006700, 50, 10, false },
	{ 7007600, 0, 10, false },
	{ 7007800, 0, 10, false },
	{ 7008600, 50, 20, false },
	{ 7009200, 0, -10, false },
	{ 7009400, -50, 0, false },
	{ 7009500, 0, 20, false },
	{ 7010000, 0, -10, false },
	{ 7010400, 0, 20, false },
	{ 7010600, 0, 20, false },
	{ 7010700, 0, 10, false },
	{ 7010800, 0, 10, false },
	{ 7011000, 0, -10, false },
	{ 7011200, 0, -10, false },
	{ 7012100, 50, 0, false },
	{ 7012700, 0, -20, false },
	{ 7012900, 50, -30, false },
	{ 7013500, 0, -10, false },
	{ 7013700, 0, -10, false },
	{ 7014200, 0, -10, false },
	{ 7014600, 0, 20, false },
	{ 7014700, 0, 20, false },
	{ 7014900, 0, 40, false },
	{ 7015200, 0, -20, false },
	{ 7015300, 50, -20, false },
	{ 7015400, 0, 30, false },
	{ 7017100, 0, -10, false },
	{ 7018800, 0, 20, false },
	{ 7029300, 0, 30, false },
	{ 7030000, 50, 0 , false },
	{ 7031000, 50, 0 , false },
	{ 7031100, 50, 0 , false },
	{ 7033000, 50, 0 , false },
	{ 7033700, 50, 0 , false },
	{ 7034000, 0, 10, false },
	{ 7034400, 0, 20, false },
	{ 7034500, 0, 30, false },
	{ 7034600, 0, 30, false },
	{ 7034700, 0, 30, false },
	{ 7034800, 0, 30, false },
	{ 7034900, 0, 30, false },
	{ 7035000, 0, 30, false },
	{ 7035900, 0, 10, false },
	{ 7037200, 0, -30, false },
	{ 7037300, 0, -90, false },
	{ 7037500, 50, 0 , false },
	{ 7037800, 0, 20, false },
	{ 7037900, 0, 20, false },
	{ 7038200, 0, -10, false },

	// 30 meters
	{ 10102500, -50, 0, false },
	{ 10102600, 50, 0, false },
	{ 10103200, 50, 0, false },
	{ 10103500, 50, 0, false },
	{ 10108200, 0, -10, false },
	{ 10108900, 0, 10, false },
	{ 10109800, -50, 0, false },
	{ 10110100, 50, 0, false },
	{ 10110800, 0, -10, false },
	{ 10111700, -50, 0, false },
	{ 10112000, 0, -10, false },
	{ 10112100, -50, 0, false },
	{ 10112900, -50, 0, false },
	{ 10113600, 0, 10, false },
	{ 10113900, 50, 0, false },
	{ 10114600, 50, 0, false },
	{ 10114800, 0, 10, false },
	{ 10115500, 0, 10, false },
	{ 10115800, 0, -10, false },
	{ 10116500, 50, 0, false },
	{ 10116700, 0, 10, false },
	{ 10117400, -50, 0, false },
	{ 10117700, 50, 0, false },
	{ 10118600, 0, 20, false },
	{ 10119300, 50, 0, false },
	{ 10119600, 0, -30, false },
	{ 10120500, 0, 50, false },
	{ 10121200, -50, 0, false },
	{ 10121400, -50, 0, false },
	{ 10122200, 50, 0, false },
	// 10.122.4-10.126.2: alternative IF2 freq
	{ 10122400, 0, 0, true },
	{ 10122500, 0, 0, true },
	{ 10122600, 0, 10, true },
	{ 10122700, 0, 0, true },
	{ 10122800, 0, -20, true },
	{ 10122900, 0, -30, true },
	{ 10123000, 0, 0, true },
	{ 10123100, 0, 100, true },
	{ 10123200, 0, 0, true },
	{ 10123300, 0, 0, true },
	{ 10123400, 0, 0, true },
	{ 10123500, 0, 0, true },
	{ 10123600, 0, 0, true },
	{ 10123700, 0, 0, true },
	{ 10123800, 0, 0, true },
	{ 10123900, 0, 0, true },
	{ 10124000, 0, 0, true },
	{ 10124100, 0, 0, true },
	{ 10124200, 0, -30, true },
	{ 10124300, 0, 20, true },
	{ 10124400, 0, -20, true },
	{ 10124500, 0, 20, true },
	{ 10124600, 0, -30, true },
	{ 10124700, 0, 0, true },
	{ 10124800, 0, 0, true },
	{ 10124900, 0, 0, true },
	{ 10125000, 0, 10, true },
	{ 10125100, 0, 0, true },
	{ 10125200, 0, 0, true },
	{ 10125300, 0, 0, true },
	{ 10125400, 0, 0, true },
	{ 10125500, 0, 0, true },
	{ 10125600, 0, -30, true },
	{ 10125700, 0, 0, true },
	{ 10125800, 0, 0, true },
	{ 10125900, 0, 0, true },
	{ 10126000, 0, 20, true },
	{ 10126100, 0, 0, true },
	{ 10126200, 0, 10, true },
	{ 10126600, 0, -10, false },
	{ 10126900, 0, 30, false },
	{ 10127100, 0, -30, false },
	{ 10127400, 0, 20, false },
	{ 10127600, 0, -30, false },
	{ 10127700, 0, -30, false },
	{ 10127800, 0, -10, false },
	{ 10127900, 0, 10, false },
	{ 10128800, 50, -10, false },
	{ 10128100, 0, -30, false },
	{ 10128500, 0, -10, false },
	{ 10128800, 0, 10, false },
	{ 10129000, 0, -20, false },
	{ 10129300, 0, -20, false },
	{ 10129400, 0, -30, false },
	{ 10129500, 0, -30, false },
	{ 10129600, 0, -80, false },
	{ 10129700, 0, -70, false },
	{ 10129800, 0, 10, false },
	{ 10129900, 0, -10, false },
	{ 10130000, 50, -40, false },

	// 20 meters
	{ 14000500, 0, 20, false },
	{ 14000700, -50, 0, false },
	{ 14001600, 50, 0, false },
	{ 14002200, 50, 0, false },
	{ 14002800, 50, 0, false },
	{ 14003700, 0, 20, false },
	{ 14003900, 50, 0, false },
	{ 14004500, 50, 10, false },
	{ 14004700, -50, 0, false },
	// 14.004.9-14.006.1: alternative IF2 freq
	{ 14004900, 0, 0, true },
	{ 14005000, 0, 0, true },
	{ 14005100, 0, 0, true },
	{ 14005200, 0, 0, true },
	{ 14005300, 0, 0, true },
	{ 14005400, 0, 0, true },
	{ 14005500, 0, 0, true },
	{ 14005600, 0, 0, true },
	{ 14005700, 0, 0, true },
	{ 14005800, 0, 10, true },
	{ 14005900, 0, 0, true },
	{ 14006000, 0, 0, true },
	{ 14006100, 0, 10, true },
	{ 14006200, 50, 0, false },
	{ 14006400, 0, -10, false },
	{ 14007000, 0, 20, false },
	{ 14008100, 0, 20, false },
	{ 14008700, 50, 0, false },
	{ 14008900, 0, 10, false },
	{ 14009800, 0, 10, false },
	// 14.011.2-14.011.8: alternative IF2 freq
	{ 14011200, 0, 0, true },
	{ 14011300, 0, 0, true },
	{ 14011400, 0, 0, true },
	{ 14011500, 0, 0, true },
	{ 14011600, 0, 0, true },
	{ 14011700, 0, 0, true },
	{ 14011800, 0, 0, true },
	{ 14035100, 50, 0, false },
	{ 14046000, 50, 0, false },
	{ 14056100, 50, 0, false },
	{ 14056700, 50, 0, false },
	{ 14059900, 0, 10, false },
	{ 14060500, 50, 0, false },
	{ 14061900, 50, 0, false },
	{ 14063200, 50, 0, false },
	{ 14063800, 50, 0, false },
	{ 14064600, 50, 0, false },
	{ 14065100, 50, 0, false },
	{ 14065700, 50, 0, false },
	{ 14067000, 50, 0, false },
	{ 14067600, 50, 0, false },
	{ 14067800, 0, -20, false },
	{ 14068200, 0, 20, false },
	{ 14068400, 50, 0, false },

	// 17 meters
	{ 18072100, 0, -20, false },
	{ 18072200, 0, -20, false },
	{ 18072300, 0, -20, false },
	{ 18072400, 0, -20, false },
	{ 18072500, 0, -20, false },
	{ 18072600, 0, -20, false },
	{ 18072700, 0, -20, false },
	{ 18072800, 0, -20, false },
	{ 18072900, 0, -20, false },
	{ 18073000, 0, -20, false },
	{ 18074200, 0, -10, false },
	{ 18074300, 0, -10, false },
	{ 18074400, 0, -10, false },
	{ 18074500, 0, -10, false },
	{ 18074600, 0, -10, false },
	{ 18074700, 0, -10, false },
	{ 18080600, 0, 20, false },
	{ 18081800, 0, -20, false },
	{ 18081900, 0, -20, false },
	{ 18082000, 0, -20, false },
	{ 18082100, 0, -20, false },
	{ 18082200, 0, -20, false },
	{ 18086700, 50, 0, false },
	{ 18087300, 0, -10, false },
	{ 18087400, 0, -10, false },
	{ 18087500, 0, -10, false },
	{ 18087600, 0, -10, false },
	{ 18087700, 0, -10, false },
	{ 18089400, 0, -10, false },
	{ 18089500, 0, -10, false },
	{ 18089600, 0, -10, false },
	{ 18089700, 0, -10, false },
	{ 18089800, 0, -10, false },
	{ 18095000, 0, -10, false },

	// 15 meters
	{ 21000000, 0, -20, false },
	{ 21000200, 0, 40, false },
	{ 21000300, 0, 40, false },
	{ 21000400, 0, 10, false },
	{ 21000600, 0, -20, false },
	{ 21000800, 0, -10, false },
	{ 21000900, 0, -10, false },
	{ 21001200, 0, -10, false },
	{ 21001300, 0, -10, false },
	{ 21001500, 0, 20, false },
	// 21.002.0 - 21.009.0: alternative IF2 freq
	{ 21002000, 0, 0, true },
	{ 21002100, 0, 0, true },
	{ 21002200, 0, 0, true },
	{ 21002300, 0, 0, true },
	{ 21002400, 0, 0, true },
	{ 21002500, 0, 0, true },
	{ 21002600, 0, 0, true },
	{ 21002700, 0, 0, true },
	{ 21002800, 0, 0, true },
	{ 21002900, 0, 0, true },
	{ 21003000, 0, -30, true },
	{ 21003100, 0, -50, true },
	{ 21003200, 0, 30, true },
	{ 21003300, 0, 10, true },
	{ 21003400, 0, 0, true },
	{ 21003500, 0, -20, true },
	{ 21003600, 0, -40, true },
	{ 21003700, 0, -20, true },
	{ 21003800, 0, 30, true },
	{ 21003900, 0, 20, true },
	{ 21004000, 0, 0, true },
	{ 21004100, 0, 0, true },
	{ 21004200, 0, 10, true },
	{ 21004300, 0, 20, true },
	{ 21004400, 0, 0, true },
	{ 21004500, 0, 20, true },
	{ 21004600, 0, 0, true },
	{ 21004700, 0, 0, true },
	{ 21004800, 0, 0, true },
	{ 21004900, 0, 0, true },
	{ 21005000, 0, -50, true },
	{ 21005100, 0, -50, true },
	{ 21005200, 0, -100, true },
	{ 21005300, 0, -100, true },
	{ 21005400, 0, -100, true },
	{ 21005500, 0, 0, true }, // TODO
	{ 21005600, 0, -130, true },
	{ 21005700, 0, -130, true },
	{ 21005800, 0, 0, true }, // TODO
	{ 21005900, 0, 70, true },
	{ 21006000, 0, 0, true }, // TODO
	{ 21006100, 0, 0, true }, // TODO
	{ 21006200, 0, 30, true },
	{ 21006300, 0, 0, true }, // TODO
	{ 21006400, 0, 0, true },
	{ 21006500, 0, -10, true }, // TODO
	{ 21006600, 0, 0, true },
	{ 21006700, 0, -40, true },
	{ 21006800, 0, -50, true },
	{ 21006900, 0, 0, true }, // TODO
	{ 21007000, 0, -80, true },
	{ 21007100, 0, 0, true }, // TODO
	{ 21007200, 0, 0, true }, // TODO
	{ 21007300, 0, 110, true },
	{ 21007400, 0, 100, true },
	{ 21007500, 0, 80, true },
	{ 21007600, 0, 90, true },
	{ 21007700, 0, 80, true },
	{ 21007800, 0, 50, true },
	{ 21007900, 0, 30, true },
	{ 21008000, 0, 20, true },
	{ 21008100, 0, 10, true },
	{ 21008200, 0, -10, true },
	{ 21008300, 0, 0, true },
	{ 21008400, 0, 10, true },
	{ 21008500, 0, 0, true },
	{ 21008600, 0, 90, true },
	{ 21008700, 0, 80, true },
	{ 21008800, 0, 70, true },
	{ 21008900, 0, 0, true },
	{ 21009000, 0, -20, true },
	{ 21009600, 0, -40, false },
	{ 21009700, 0, -40, false },
	{ 21009800, 0, -40, false },
	{ 21010200, 0, -40, false },
	{ 21010300, -50, -40, false },
	{ 21010400, 0, -40, false },
	{ 21011000, 0, -20, false },
	{ 21011100, 0, -20, false },
	{ 21011500, 0, -10, false },
	{ 21012400, 0, -20, false },
	{ 21012700, 0, -20, false },
	{ 21012900, 0, -10, false },
	{ 21013600, 0, -10, false },
	{ 21014000, 0, 10, false },
	{ 21014700, 0, -40, false },
	{ 21014800, 0, -40, false },
	{ 21014900, 0, -40, false },
	{ 21015200, 0, -10, false },
	{ 21015400, 0, -20, false },
	{ 21015500, 0, -20, false },
	// 21.016.4-21.017.9: alternative IF2 freq
	{ 21016400, 0, -30, true },
	{ 21016500, 0, 0, true },
	{ 21016600, 0, 10, true },
	{ 21016700, 0, 30, true },
	{ 21016800, 0, 0, true },
	{ 21016900, 0, 0, true },
	{ 21017000, 0, 0, true },
	{ 21017100, 0, 0, true },
	{ 21017200, 0, 0, true },
	{ 21017300, 0, 0, true },
	{ 21017400, 0, 0, true },
	{ 21017500, 0, 0, true },
	{ 21017600, 0, 0, true },
	{ 21017700, 0, 0, true },
	{ 21017800, 0, 0, true },
	{ 21017900, 0, 0, true },
	{ 21019700, 0, -10, false },
	{ 21019800, 0, -10, false },
	{ 21020400, 0, -10, false },
	{ 21020500, 0, -10, false },
	{ 21022300, 0, -10, false },
	{ 21023000, 0, -10, false },
	{ 21024800, 0, -10, false },
	{ 21024900, 0, -10, false },
	{ 21027300, 0, -10, false },
	{ 21027400, 0, -10, false },
	{ 21028000, 0, -10, false },
	{ 21028100, 0, -10, false },
	{ 21032400, 0, -10, false },
	{ 21033100, 0, -10, false },
	{ 21034900, 0, -10, false },
	{ 21035000, 0, -10, false },
	{ 21037400, 0, -10, false },
	{ 21037500, 0, -10, false },
	{ 21064300, -50, 0, false },

	// 12 meters
	{ 24894800, 50, 0, false },
	{ 24904400, 50, 0, false },
	{ 24909700, 50, 0, false },
	{ 24910300, 50, 0, false },
	{ 24910700, 50, 0, false },
	{ 24913200, 50, 0, false },
	{ 24914200, 50, 0, false },

	// 10 meters
	{ 28000900, 0, -10, false },
	{ 28002600, 50, 0, false },
	{ 28002800, 50, -10, false },
	{ 28003900, 0, -20, false },
	{ 28004000, 0, -20, false },
	{ 28004100, 0, -30, false },
	{ 28004500, 0, -10, false },
	{ 28004600, 0, 20, false },
	{ 28005100, 50, 0, false },
	{ 28006200, 50, 0, false },
	{ 28006800, 0, -10, false },
	{ 28007000, 0, -10, false },
	{ 28007600, -50, 0, false },
	{ 28008700, 50, 0, false },
	{ 28009300, 50, 0, false },
	{ 28015500, 50, 0, false },
	{ 28024300, 50, 0, false },
	{ 28033900, 50, 0, false },
	{ 28037900, 50, 0, false },
	{ 28040700, 50, 0, false },
	{ 28050400, 50, 0, false },
	{ 28051600, 50, 0, false },
	{ 28052500, 50, 0, false },
	{ 28053400, 50, 0, false },
	{ 28054300, 50, 0, false },
	{ 28054400, 50, 0, false },
	{ 28058300, 50, 0, false },
	{ 28059200, 50, 0, false },
	{ 28060200, 50, 0, false },
}; 

bool isSpurMaskingInfoSorted(int32_t* first_mismatch) {
	int i;
	for(i = 1; i < sizeof(SpurMaskInfoArray)/sizeof(SpurMaskInfoArray[0]); i++) {
		if(SpurMaskInfoArray[i].freq <= SpurMaskInfoArray[i-1].freq) {
			*first_mismatch = SpurMaskInfoArray[i].freq;
			return false;
		}
	}

	return true;
}

const SpurMaskInfo* getSpurMaskingInfo(int32_t freq) {
	// binary search
	int left = 0;
	int right = sizeof(SpurMaskInfoArray)/sizeof(SpurMaskInfoArray[0]) - 1;

	while(left <= right) {
		int current = (left + right) / 2;
		if(SpurMaskInfoArray[current].freq == freq) {
			return &SpurMaskInfoArray[current];
		}

		if(SpurMaskInfoArray[current].freq > freq) {
			right = current - 1;
		} else {
			left = current + 1;
		}
	}

	/* not found */
	return NULL;
}